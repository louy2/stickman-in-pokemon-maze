name: Deploy to Aliyun OSS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ossutil
        run: |
          curl -o ossutil64 https://gosspublic.alicdn.com/ossutil/1.7.18/ossutil-v1.7.18-linux-amd64.zip
          unzip ossutil64
          chmod +x ossutil-v1.7.18-linux-amd64/ossutil64
          sudo mv ossutil-v1.7.18-linux-amd64/ossutil64 /usr/local/bin/ossutil

      - name: Configure ossutil
        run: |
          ossutil config \
            -e ${{ vars.ALIYUN_OSS_ENDPOINT }} \
            -i ${{ secrets.ALIYUN_ACCESS_KEY_ID }} \
            -k ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}

      - name: Deploy to OSS
        run: |
          # Sync all static files to OSS bucket
          ossutil sync . oss://${{ vars.ALIYUN_OSS_BUCKET }}/ \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "LICENSE" \
            --exclude "README.md" \
            --delete \
            --force

      - name: Set Cache-Control headers
        run: |
          # Set appropriate cache headers for different file types
          # HTML files - no cache to always get latest
          ossutil set-meta oss://${{ vars.ALIYUN_OSS_BUCKET }}/ \
            "Cache-Control:no-cache, no-store, must-revalidate" \
            --include "*.html" \
            --recursive \
            --force

          # JS and CSS files - cache for 1 day
          ossutil set-meta oss://${{ vars.ALIYUN_OSS_BUCKET }}/ \
            "Cache-Control:public, max-age=86400" \
            --include "*.js" \
            --include "*.css" \
            --recursive \
            --force
